# Base image
FROM python:3.9-alpine as base

# Set working directory
WORKDIR /app

# Copy requirements.txt file
COPY requirements.txt .

# Install required packages
RUN apk add --no-cache gcc musl-dev libffi-dev openssl-dev clamav-daemon clamav-libunrar nginx \
    && pip install --no-cache-dir -r requirements.txt \
    && rm /etc/nginx/conf.d/default.conf

# Copy Nginx configuration
COPY nginx/main.conf /etc/nginx/conf.d/

# Copy ModSecurity configuration
COPY modsecurity/modsecurity.conf /etc/nginx/modsecurity.d/

# Copy OWASP CRS rules
COPY modsecurity/rules/ /etc/nginx/modsecurity.d/rules/

# Copy ClamAV configuration
COPY clamav/clamd.conf /etc/clamav/

# Copy ClamAV virus database
RUN freshclam

# Copy application files
COPY app/ .

# Expose ports
EXPOSE 80
EXPOSE 443

# Start ClamAV daemon
CMD ["clamd"]

# Build Flask server image
FROM base as server

# Start Flask server
CMD ["python", "app.py"]

# Build Nginx image
FROM base as nginx

# Start Nginx
CMD ["nginx", "-g", "daemon off;"]
