import os
from flask import Flask, request, jsonify
import traceback
import clamd

app = Flask(__name__)

@app.route('/upload_file', methods=['POST'])
def upload_file():
    status = 200
    response = {}
    try:
        file = request.files['testfile']
        cd = clamd.ClamdNetworkSocket()
        cd.__init__(host='localhost', port=3310, timeout=None)
        scan_result = cd.instream(file)
        
        if (scan_result['stream'][0] == 'OK'):
            message = 'file has no virus'
            file_path = os.path.join('clean_files', file.filename)
            file.save(file_path)
            response['file_path'] = file_path
            print(scan_result['stream'])
        elif (scan_result['stream'][0] == 'FOUND'):
            message = 'file has virus'
            print(scan_result['stream'])
        else:
            message = 'Error occured while processing'
        response['message'] = message
    except Exception as exp:
        print(traceback.format_exc())
        status = 500
        response['code'] = 500
        response['message'] = str(exp)
    return jsonify(response), status

@app.route('/serve_file/<filename>', methods=['GET'])
def serve_file(filename):
    try:
        file_path = os.path.join('clean_files', filename)
        if os.path.exists(file_path):
            return app.send_static_file(file_path)
        else:
            return "File not found", 404
    except Exception as exp:
        print(traceback.format_exc())
        return str(exp), 500

if __name__ == '__main__':
    app.run(debug=True)
